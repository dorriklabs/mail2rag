volumes:
  anythingllm_storage:
  mail2rag_archive:
  qdrant_data:
  bm25_data:


networks:
  rag_net:
    driver: bridge

services:
  # 1. ANYTHINGLLM
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: anythingllm
    ports:
      - "3001:3001"
    env_file:
      - ./.env
    environment:
      STORAGE_DIR: /app/server/storage
      TZ: Europe/Paris
    volumes:
      - anythingllm_storage:/app/server/storage
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:3001/api/v1/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 20s
    restart: unless-stopped
    networks:
      - rag_net
    depends_on:
      qdrant:
        condition: service_started

  # 2. QDRANT (Vector Database)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - rag_net

  # 3. RAG PROXY (FastAPI + Qdrant + BM25 + LM Studio)
  rag_proxy:
    build:
      context: ./ragproxy
      dockerfile: Dockerfile
    container_name: rag_proxy
    env_file:
      - ./.env
    environment:
      TZ: Europe/Paris

      # LM Studio sur la machine hôte
      LM_STUDIO_URL: "http://host.docker.internal:1234"

      # Accès à Qdrant dans le réseau Docker
      VECTOR_DB_HOST: "qdrant"
      VECTOR_DB_PORT: "6333"
      VECTOR_DB_COLLECTION: "default-workspace"

      # BM25 index (optionnel)
      BM25_INDEX: "/bm25/bm25.pkl"
      USE_BM25: "true"

      REQUEST_TIMEOUT: "20"
    volumes:
      - bm25_data:/bm25
    ports:
      - "8000:8000"
    depends_on:
      qdrant:
        condition: service_started
    restart: unless-stopped
    networks:
      - rag_net
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # 4. MAIL2RAG (Application Python)
  mail2rag:
    build:
      context: ./mail2rag
      dockerfile: Dockerfile
    container_name: mail2rag
    env_file:
      - ./.env
    environment:
      TZ: Europe/Paris
    volumes:
      # Code source (dev hot-reload)
      - ./mail2rag:/app
      # Routing configuration
      - ./routing.json:/etc/mail2rag/routing.json:ro
      # Prompts directory
      - ./mail2rag/prompts:/etc/mail2rag/prompts:ro
      # Logs
      - ./logs:/var/log/mail2rag
      # State
      - ./state:/var/lib/mail2rag
      # Archive (volume nommé)
      - mail2rag_archive:/var/lib/mail2rag/mail2rag_archive
    depends_on:
      anythingllm:
        condition: service_healthy
      qdrant:
        condition: service_started
      rag_proxy:
        condition: service_started
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    networks:
      - rag_net

  # 5. ARCHIVE SERVER (NGINX)
  archive_server:
    image: nginx:alpine
    container_name: mail2rag_archive_server
    ports:
      - "8080:80"
    volumes:
      # Custom Nginx configuration
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Archive en lecture seule
      - mail2rag_archive:/usr/share/nginx/html:ro
    depends_on:
      - mail2rag
    restart: unless-stopped
    networks:
      - rag_net
