# Définition des volumes persistants nommés (Gestionnée par Docker)
volumes:
  anythingllm_storage:
  mail2rag_archive:
  qdrant_data:
  bm25_data:


networks:
  rag_net:
    driver: bridge

services:
  # 1. ANYTHINGLLM (MISE À JOUR DES DÉPENDANCES V44)
  anythingllm:
    image: mintplexlabs/anythingllm:latest
    container_name: anythingllm
    ports:
      - "3001:3001"
    env_file:
      - ./.env
    environment:
      STORAGE_DIR: /app/server/storage
      TZ: Europe/Paris
    volumes:
      - anythingllm_storage:/app/server/storage
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:3001/api/v1/health || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 20s
    restart: unless-stopped
    networks:
      - rag_net
    depends_on:
      qdrant:
        condition: service_started

  # 2. QDRANT (Base de Données Vectorielle)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: always
    networks:
      - rag_net

  # 3. RAG PROXY (FastAPI + Qdrant + BM25 + LM Studio)
  rag_proxy:
    build:
      context: ./ragproxy # contient Dockerfile, requirements.txt, main.py, app/
      dockerfile: Dockerfile
    container_name: rag_proxy
    env_file:
      - ./.env
    environment:
      TZ: Europe/Paris

      # LM Studio tourne sur la machine hôte, port à adapter si besoin
      LM_STUDIO_URL: "http://host.docker.internal:1234"

      # Accès à la base vectorielle dans le réseau docker
      VECTOR_DB_HOST: "qdrant"
      VECTOR_DB_PORT: "6333"
      VECTOR_DB_COLLECTION: "documents"

      # BM25 index (optionnel, ignoré si le fichier n'existe pas)
      BM25_INDEX: "/bm25/bm25.pkl"
      USE_BM25: "true"

      REQUEST_TIMEOUT: "20"
    volumes:
      - bm25_data:/bm25 # /bm25/bm25.pkl dans le conteneur
    ports:
      - "8000:8000" # pratique pour tester depuis l’hôte
    depends_on:
      qdrant:
        condition: service_started
    restart: unless-stopped
    networks:
      - rag_net
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # 4. MAIL2RAG (Votre application Python)
  mail2rag:
    build:
      context: ./mail2rag
      dockerfile: Dockerfile
    container_name: mail2rag
    env_file:
      - ./.env
    environment:
      TZ: Europe/Paris
      ANYTHINGLLM_BASE_URL: "http://anythingllm:3001"
      PYTHONUNBUFFERED: "1"
      STATE_PATH: "/var/lib/mail2rag/state.json"
      ARCHIVE_PATH: "/var/lib/mail2rag/mail2rag_archive"
      ROUTING_PATH: "/etc/mail2rag/routing.json"
    volumes:
      # Montage des fichiers sources (pour le développement)
      - ./mail2rag:/app
      # Routing configuration
      - ./routing.json:/etc/mail2rag/routing.json:ro
      # NEW: Prompts directory
      - ./mail2rag/prompts:/etc/mail2rag/prompts:ro
      # Montage des logs (pour le débogage)
      - ./logs:/var/log/mail2rag
      # State and data
      - ./state:/var/lib/mail2rag
      # Archive (volume nommé)
      - mail2rag_archive:/var/lib/mail2rag/mail2rag_archive
    depends_on:
      anythingllm:
        condition: service_healthy
      qdrant:
        condition: service_started
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    networks:
      - rag_net

  # 5. ARCHIVE SERVER (NGINX)
  archive_server:
    image: nginx:alpine
    container_name: mail2rag_archive_server
    ports:
      - "8080:80"
    volumes:
      # Custom Nginx configuration
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Archive servie en lecture seule
      - mail2rag_archive:/usr/share/nginx/html:ro
    depends_on:
      - mail2rag
    restart: always
    networks:
      - rag_net
